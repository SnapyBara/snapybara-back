<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©initialiser le mot de passe - SnapyBara</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .logo p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 10px;
        }
        
        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .requirement {
            margin: 2px 0;
        }
        
        .requirement.valid {
            color: #060;
        }
        
        .requirement.invalid {
            color: #c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>ü¶å SnapyBara</h1>
            <p>R√©initialiser votre mot de passe</p>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>
        
        <form id="reset-form">
            <div class="form-group">
                <label for="password">Nouveau mot de passe</label>
                <input type="password" id="password" name="password" required>
                <div class="password-requirements">
                    <div class="requirement" id="req-length">‚Ä¢ Au moins 8 caract√®res</div>
                    <div class="requirement" id="req-upper">‚Ä¢ Une majuscule</div>
                    <div class="requirement" id="req-lower">‚Ä¢ Une minuscule</div>
                    <div class="requirement" id="req-number">‚Ä¢ Un chiffre</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirm-password">Confirmer le mot de passe</label>
                <input type="password" id="confirm-password" name="confirm-password" required>
            </div>
            
            <button type="submit" class="btn" id="submit-btn">Changer le mot de passe</button>
            
            <div class="loading" id="loading">
                <p>Changement en cours...</p>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase
        const supabaseUrl = 'YOUR_SUPABASE_URL'; // √Ä remplacer
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // √Ä remplacer
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // √âl√©ments DOM
        const form = document.getElementById('reset-form');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        // Variables pour stocker la session de reset
        let resetSession = null;

        // Validation en temps r√©el du mot de passe
        passwordInput.addEventListener('input', validatePassword);
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        function validatePassword() {
            const password = passwordInput.value;
            
            // V√©rification longueur
            const lengthReq = document.getElementById('req-length');
            if (password.length >= 8) {
                lengthReq.classList.add('valid');
                lengthReq.classList.remove('invalid');
            } else {
                lengthReq.classList.add('invalid');
                lengthReq.classList.remove('valid');
            }
            
            // V√©rification majuscule
            const upperReq = document.getElementById('req-upper');
            if (/[A-Z]/.test(password)) {
                upperReq.classList.add('valid');
                upperReq.classList.remove('invalid');
            } else {
                upperReq.classList.add('invalid');
                upperReq.classList.remove('valid');
            }
            
            // V√©rification minuscule
            const lowerReq = document.getElementById('req-lower');
            if (/[a-z]/.test(password)) {
                lowerReq.classList.add('valid');
                lowerReq.classList.remove('invalid');
            } else {
                lowerReq.classList.add('invalid');
                lowerReq.classList.remove('valid');
            }
            
            // V√©rification chiffre
            const numberReq = document.getElementById('req-number');
            if (/[0-9]/.test(password)) {
                numberReq.classList.add('valid');
                numberReq.classList.remove('invalid');
            } else {
                numberReq.classList.add('invalid');
                numberReq.classList.remove('valid');
            }
            
            validatePasswordMatch();
        }

        function validatePasswordMatch() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            const isValid = password.length >= 8 && 
                           /[A-Z]/.test(password) && 
                           /[a-z]/.test(password) && 
                           /[0-9]/.test(password) &&
                           password === confirmPassword &&
                           confirmPassword.length > 0;
            
            submitBtn.disabled = !isValid;
        }

        // Gestion du formulaire
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // Cacher messages pr√©c√©dents
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Validation
            if (password !== confirmPassword) {
                showError('Les mots de passe ne correspondent pas');
                return;
            }
            
            if (password.length < 8) {
                showError('Le mot de passe doit contenir au moins 8 caract√®res');
                return;
            }
            
            // Afficher loading
            submitBtn.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                console.log('üîÑ Tentative de changement de mot de passe...');
                
                // Changer le mot de passe avec Supabase
                const { data, error } = await supabase.auth.updateUser({
                    password: password
                });
                
                if (error) {
                    console.error('‚ùå Erreur Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Mot de passe chang√© avec succ√®s!');
                
                // Succ√®s !
                successMessage.innerHTML = `
                    <strong>‚úÖ Mot de passe chang√© avec succ√®s !</strong><br>
                    Redirection vers l'application...
                `;
                successMessage.style.display = 'block';
                
                // Redirection vers l'app apr√®s 2 secondes
                setTimeout(() => {
                    window.location.href = 'snapybara://password-changed';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erreur lors du changement:', error);
                showError('Erreur lors du changement de mot de passe: ' + error.message);
                
                // R√©afficher le bouton
                submitBtn.style.display = 'block';
                loading.style.display = 'none';
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Fonction pour extraire les param√®tres de l'URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            console.log('üîç URL search params:', Object.fromEntries(urlParams));
            console.log('üîç Hash params:', Object.fromEntries(hashParams));
            
            return {
                access_token: urlParams.get('access_token') || hashParams.get('access_token'),
                refresh_token: urlParams.get('refresh_token') || hashParams.get('refresh_token'),
                expires_in: urlParams.get('expires_in') || hashParams.get('expires_in'),
                expires_at: urlParams.get('expires_at') || hashParams.get('expires_at'),
                token_type: urlParams.get('token_type') || hashParams.get('token_type'),
                type: urlParams.get('type') || hashParams.get('type')
            };
        }

        // Initialisation et gestion de la session de reset
        window.addEventListener('load', async () => {
            console.log('üîê √âtablissement de la session s√©curis√©e...');
            console.log('üîç URL compl√®te:', window.location.href);
            console.log('üîç Search:', window.location.search);
            console.log('üîç Hash:', window.location.hash);
            
            try {
                // Attendre un peu pour que Supabase traite automatiquement les tokens
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Extraire les param√®tres de l'URL
                const params = getUrlParams();
                console.log('üìã Param√®tres URL d√©tect√©s:', params);
                
                // Premi√®re approche : v√©rifier si Supabase a automatiquement trait√© les tokens
                console.log('üîç V√©rification session automatique...');
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionData?.session && !sessionError) {
                    console.log('‚úÖ Session automatique trouv√©e:', sessionData.session);
                    resetSession = sessionData.session;
                    
                    // V√©rifier l'utilisateur
                    const { data: userData, error: userError } = await supabase.auth.getUser();
                    if (userData?.user && !userError) {
                        console.log('‚úÖ Utilisateur authentifi√© automatiquement:', userData.user.email);
                        return; // Tout est OK
                    }
                }
                
                // Deuxi√®me approche : traitement manuel des tokens
                if (params.access_token && params.refresh_token) {
                    console.log('üîë Tokens d√©tect√©s, √©tablissement manuel de la session...');
                    
                    // Essayer diff√©rentes m√©thodes selon le type
                    let sessionResult;
                    
                    if (params.type === 'recovery') {
                        // Pour recovery, utiliser setSession
                        sessionResult = await supabase.auth.setSession({
                            access_token: params.access_token,
                            refresh_token: params.refresh_token
                        });
                    } else {
                        // Pour les autres cas, essayer refreshSession
                        sessionResult = await supabase.auth.refreshSession({
                            refresh_token: params.refresh_token
                        });
                    }
                    
                    if (sessionResult.error) {
                        console.error('‚ùå Erreur √©tablissement session:', sessionResult.error);
                        throw sessionResult.error;
                    }
                    
                    console.log('‚úÖ Session √©tablie manuellement:', sessionResult.data);
                    resetSession = sessionResult.data.session;
                    
                    // V√©rifier l'utilisateur
                    const { data: userData, error: userError } = await supabase.auth.getUser();
                    if (userError || !userData.user) {
                        console.error('‚ùå Impossible de r√©cup√©rer l\'utilisateur:', userError);
                        throw new Error('Session invalide apr√®s √©tablissement');
                    }
                    
                    console.log('‚úÖ Utilisateur authentifi√©:', userData.user.email);
                    
                    // Nettoyer l'URL
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    
                } else {
                    // Troisi√®me approche : essayer de g√©rer via l'√©v√©nement de Supabase
                    console.log('üîç Tentative via √©v√©nements auth...');
                    
                    // Attendre les √©v√©nements d'auth de Supabase
                    let authEventReceived = false;
                    
                    const authSubscription = supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('üîÑ √âv√©nement auth re√ßu:', event, session);
                        
                        if (event === 'PASSWORD_RECOVERY' || event === 'SIGNED_IN') {
                            authEventReceived = true;
                            resetSession = session;
                            
                            if (session?.user) {
                                console.log('‚úÖ Session via √©v√©nement:', session.user.email);
                                return;
                            }
                        }
                    });
                    
                    // Attendre maximum 5 secondes pour un √©v√©nement
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    
                    // Nettoyer la subscription
                    authSubscription.data.subscription.unsubscribe();
                    
                    if (!authEventReceived) {
                        console.log('‚ö†Ô∏è Aucun √©v√©nement auth re√ßu, param√®tres manquants:', params);
                        throw new Error('Auth session missing! Aucune session trouv√©e.');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'√©tablissement de la session:', error.message);
                showError('Erreur lors de l\'√©tablissement de la session: ' + error.message + 
                         '. Veuillez redemander un nouveau lien de r√©initialisation.');
                form.style.display = 'none';
                
                // Afficher des informations de debug
                console.log('üîç Debug info:');
                console.log('- URL compl√®te:', window.location.href);
                console.log('- Param√®tres extraits:', getUrlParams());
            }
        });

        // √âcouter les changements d'√©tat d'authentification
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('üîÑ Changement d\'√©tat auth:', event, session);
            
            if (event === 'PASSWORD_RECOVERY') {
                console.log('üîë Mode r√©cup√©ration de mot de passe activ√©');
                resetSession = session;
            }
        });
    </script>
</body>
</html>
